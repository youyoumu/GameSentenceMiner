import path from 'path';
import { log } from '../logger.js';
import { Extension } from './_util.js';

class YomitanExtension extends Extension {
    constructor() {
        super({
            name: 'yomitan',
            downloadUrl: async () => {
                const apiUrl = 'https://api.github.com/repos/themoeway/yomitan/releases/latest';
                const res = await fetch(apiUrl);
                const release = (await res.json()) as {
                    assets: { browser_download_url: string; name: string }[];
                };

                const asset = release.assets.find((a) => a.name.includes('yomitan-chrome.zip'));
                if (!asset) throw new Error('Chrome zip not found in release');
                return asset.browser_download_url;
            },
        });
    }

    async extractExtension() {
        const extensionPath = await super.extractExtension();
        if (!extensionPath) {
            log.warn('Cancelling yomitan shimming');
            return;
        }

        //shim some yomitan files
        const targets = [path.join(extensionPath, 'js', 'data', 'permissions-util.js')];
        for (const target of targets) {
            try {
                Extension.shimFile(target, path.join(import.meta.dirname, './yomitan-shim.js'));
                log.info(`Shimmed: ${target}`);
            } catch {
                log.error(`Failed to shim ${target}`);
            }
        }
        return extensionPath;
    }
}

export const yomitanExtension = new YomitanExtension();
